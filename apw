#!/bin/env sh

check_package_manager() {
  if /bin/flatpak --version >/dev/null 2>&1; then
    printf "flatpak" >~/.cache/apw/package_manager
  elif apt -v >/dev/null 2>&1; then
    printf "apt" >~/.cache/apw/package_manager
  elif choco -v >/dev/null 2>&1; then
    printf "choco" >~/.cache/apw/package_manager
  fi
}

startup() {
  if test ! -d ~/.cache/apw/; then
    mkdir -p ~/.cache/apw/
  fi

  if test ! -f ~/.cache/apw/package_manager; then
    check_package_manager
  fi
}

update_cache() {
  case $PACKAGE_MANAGER in
  choco)
    choco list -lo | grep -v 'packages installed' |
      cut -d ' ' -f 1 |
      tail -n +2 >~/.cache/apw/installed
    ;;
  apt)
    (apt list --installed | sed 's/\/.*$//g') \
      >~/.cache/apw/installed

    ;;
  flatpak)
    (/bin/flatpak --user list) >~/.cache/apw/installed
    ;;
  esac
}

fn_add() {
  case $PACKAGE_MANAGER in
  apt)
    sudo apt update
    sudo apt install "$@"
    ;;
  choco)
    choco install "$@"
    update_cache
    ;;
  flatpak)
    /bin/flatpak --user install "$@"
    ;;
  esac
}

fn_search() {
  case $PACKAGE_MANAGER in
  apt)
    sudo apt update
    apt search "$@"
    ;;
  choco) ;;
  flatpak)
    /bin/flatpak --user search "$@"
    ;;
  esac
}

fn_del() {
  case $PACKAGE_MANAGER in
  apt)
    apt purge "$@"
    apt autoremove -y
    ;;
  choco)
    choco uninstall "$@"
    update_cache
    ;;
  flatpak)
    /bin/flatpak --user uninstall "$@"
    ;;
  esac
}

fn_upgrade() {
  case $PACKAGE_MANAGER in
  apt)
    sudo apt update
    sudo apt upgrade -y
    sudo apt autoremove -y >/dev/null 2>&1
    ;;
  choco)
    choco upgrade all -y
    update_cache
    ;;
  flatpak)
    /bin/flatpak --user update
    ;;
  esac
}

fn_info() {
  case $PACKAGE_MANAGER in
  apt)
    apt list --installed
    ;;
  choco)
    if test ! -f ~/.cache/apw/installed; then
      update_cache
    fi
    cat ~/.cache/apw/installed
    ;;
  flatpak)
    /bin/flatpak --user list
    ;;
  esac
}

main() {
  startup

  PACKAGE_MANAGER=$(cat ~/.cache/apw/package_manager)

  # shellcheck disable=SC2068
  $@
}

main fn_"$*"
